

### 禁用 CD-ROM 仓库(如果ubuntu系统安装到时候未自选源)
sudo nano /etc/apt/sources.list
deb cdrom:[Your Ubuntu Version] /cdrom/
修复 dpkg 问题
sudo dpkg --configure -a

### 创建网桥 br0 和 enp2s0 的配置文件
```
sudo tee /etc/systemd/network/br0.netdev > /dev/null << EOF
[NetDev]
Name=br0
Kind=bridge
EOF
```
创建 /etc/systemd/network/enp2s0.network 来配置 enp2s0 作为桥接从属设备：
```
sudo tee /etc/systemd/network/enp2s0.network > /dev/null << EOF
[Match]
Name=enp2s0
[Network]
Bridge=br0
EOF
```
配置 br0 作为具有静态 IP 的桥接接口
```
sudo tee /etc/systemd/network/br0.network > /dev/null << EOF
[Match]
Name=br0
[Network]
Address=192.168.8.16/24
Gateway=192.168.8.1
DNS=8.8.8.8
DNS=8.8.4.4
EOF
```
查看文件确保配置正确并准备应用
```
cat /etc/systemd/network/br0.netdev
cat /etc/systemd/network/enp2s0.network
cat /etc/systemd/network/br0.network
确认后应用更改
sudo netplan apply 
```

编辑原始文件vi /etc/netplan/00-installer-config.yaml或者删除文件
```
sudo rm /etc/netplan/*.yaml
```
逐步应用配置
```
sudo systemctl restart systemd-networkd
sudo networkctl reload
```
验证配置
```
networkctl status br0
```
最终确认并应用
```
sudo systemctl restart systemd-networkd
```
重启电脑
```
reboot
```
检查桥接配置是否生效：
```
nmcli device status
brctl show
ip addr
ip addr show br0
ip addr show enp2s0
```


安装软件
```
sudo apt update
sudo apt install -y qemu-kvm libvirt-daemon-system libvirt-clients virtinst
```
开启kvm服务，并且设置其开机自动启动
```
systemctl start libvirtd
systemctl enable libvirtd
systemctl status libvirtd
```
确保 qemu 用户（通常是 qemu 或 libvirt-qemu 用户）具有对 ISO 文件和目录的读取权限。
```
sudo chown qemu:qemu /home/iso/19044.3693.231108-0702.21H2_RELEASE_SVC_PROD1_CLIENT_X64FRE_ZH-CN.iso
sudo chmod 644 /home/iso/19044.3693.231108-0702.21H2_RELEASE_SVC_PROD1_CLIENT_X64FRE_ZH-CN.iso
sudo chown qemu:qemu /home/iso/virtio-win-0.1.262.iso
sudo chmod 644 /home/iso/virtio-win-0.1.262.iso
```
```
sudo chmod o+x /home #调整父目录权限
sudo chmod o+x /home/iso
sudo usermod -aG libvirt qemu #确保 libvirt-qemu 用户具有适当的权限
```

### 加载 Virtio 驱动程序
```
在 Windows 安装程序中，选择安装磁盘时出现“找不到驱动器”或“无法识别磁盘”提示。
* 点击“加载驱动程序”（Load driver）。
* 点击“浏览”（Browse），然后选择 Virtio 驱动程序 ISO 中的文件夹。选择对应的驱动程序路径，通常是 viostor 目录中的 .inf 文件。
在安装程序加载了 Virtio 驱动程序后，您应该能看到虚拟磁盘。在列表中选择磁盘，点击“下一步”进行分区和格式化，然后继续安装 Windows。
```

### 安装win系统 构建时即分配磁盘目录
```
virt-install \
  --virt-type=kvm \
  --name=vm31 \
  --vcpus=24 \
  --memory=16384 \
  --cdrom /home/iso/ubuntu-24.04.1-live-server-amd64.iso \
  --disk path=/home/iso/vm31.qcow2,size=50,format=qcow2,bus=virtio \
  --disk path=/home/iso/virtio-win-0.1.262.iso,device=cdrom,perms=rw \
  --network bridge=br0,model=e1000,mac=52:54:00:12:34:68 \
  --graphics vnc,port=5990,listen=0.0.0.0,password=782954 \
  --os-variant=win10 \
  --cpu host-passthrough \
  --features kvm_hidden=on \
  --force
```
### 安装linux系统 构建时即分配磁盘目录
```
virt-install \
  --virt-type=kvm \
  --name=vm31 \
  --vcpus=24 \
  --memory=16384 \
  --cdrom /home/iso/ubuntu-24.04.1-live-server-amd64.iso \
  --disk path=/home/iso/vm31.qcow2,size=50,format=qcow2,bus=virtio \
  --disk path=/home/iso/virtio-win-0.1.262.iso,device=cdrom,perms=rw \
  --network bridge=br0,model=e1000,mac=52:54:00:12:34:68 \
  --graphics vnc,port=5990,listen=0.0.0.0,password=782954 \
  --os-variant= linux \
  --cpu host-passthrough \
  --features kvm_hidden=on \
  --force
```

### macOS 下，⌘ + Space 启动 Spotlight，输入：
```
vnc://192.168.8.16:5990
```



## Kvm显卡直通
检查硬件是否支持 IOMMU
```
dmesg | grep -e DMAR -e IOMMU
```
配置了 IOMMU
修改文件vi /etc/default/grub 
```
GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on iommu=pt pcie_acs_override=downstream,multifunction video=vesafb:off video=efifb:off ignore_msrs=1 "
```
重构内核并重启系统
```
sudo grub-mkconfig -o /boot/grub/grub.cfg   #efi启动的系统//ubuntu
grub2-mkconfig -o /boot/grub2/grub.cfg      #bios启动系统
grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg   #efi启动的系统
GRUB_ENABLE_BLSCFG=false  #centos9 应该把此参数改为false，确保重启有效
```
### 禁用默认显卡驱动nouveau 驱动/编辑硬件黑名单 
```
vim /usr/lib/modprobe.d/dist-blacklist.conf
vim /etc/modprobe.d/blacklist.conf
```
 在.conf文件中加上
```
blacklist nouveau
options nouveau modeset=0 
blacklist nvidiafb
blacklist nvidia
blacklist snd_hda_intel
blacklist snd_hda_codec_hdmi
blacklist i915
```

### 编辑 VFIO 配置文件
编辑开机启动模块 vi /etc/modules 
```
添加以下
vfio
vfio_iommu_type1
vfio_pci
```
另外修改vi /etc/modprobe.d/vfio.conf
```
#绑定设备
options vfio-pci ids=10de:2206,10de:1aef
```

添加到系统启动加载模块
```
echo 'vfio-pci' > /etc/modules-load.d/vfio-pci.conf
```
重构内核
```
sudo apt install dracut #安装dracut
sudo dracut --force   #重新生成 initramfs 
sudo reboot     #重启系统
```

### vfio-pci手动解绑显卡
```
echo 0000:01:00.0 > /sys/bus/pci/devices/0000:01:00.0/driver/unbind
echo 0000:01:00.1 > /sys/bus/pci/devices/0000:01:00.1/driver/unbind
lspci -nnk -d 10de:  
```
### vfio-pci手动绑定显卡
```
sudo modprobe vfio-pci  #内核加载模块
echo "10de 2206" > /sys/bus/pci/drivers/vfio-pci/new_id
echo "10de 1aef" > /sys/bus/pci/drivers/vfio-pci/new_id
echo vfio-pci > /sys/bus/pci/devices/0000:01:00.0/driver_override
echo vfio-pci > /sys/bus/pci/devices/0000:01:00.1/driver_override
echo 0000:01:00.0 > /sys/bus/pci/drivers/vfio-pci/bind
echo 0000:01:00.1 > /sys/bus/pci/drivers/vfio-pci/bind
```
### virsh 命令解绑显卡
```
sudo virsh nodedev-reattach pci_0000_01_00_0 #解除绑定 GPU
sudo virsh nodedev-reattach pci_0000_01_00_1
```
### virsh 命令绑定显卡
```
sudo virsh nodedev-detach pci_0000_01_00_0  #绑定GPU到vfio-pci 
sudo virsh nodedev-detach pci_0000_01_00_1
```


### 给虚拟机添加新硬件
```
virsh edit vm12 
```
设置显卡（domain devices属性内）
```
<hostdev mode='subsystem' type='pci' managed='yes'>  
  <source>
    <address domain='0x0000' bus='0x01' slot='0x00' function='0x0'/>
  </source>
</hostdev>

<hostdev mode='subsystem' type='pci' managed='yes'>  
  <source>
    <address domain='0x0000' bus='0x01' slot='0x00' function='0x1'/>
  </source>
</hostdev>
```

设置cpu (在domain属性内)
```
  <cpu mode='host-passthrough' check='none' migratable='on'>
    <topology sockets='1' cores='24' threads='1'/>
    <feature policy="disable" name="hypervisor"/>
  </cpu>

    <feature policy='disable' name='vmx'/> 
    <feature policy='disable' name='svm'/>  
```


### 排查命令
```
lspci -nnk -d 10de:  #显卡当前绑定的驱动
lspci -nn | grep -i nvidia #检测显卡
lsmod | grep nouveau #查看是否加载
lsmod | grep vfio   #一定要查看是否加载//已经静态编辑到内核后没有任何显示
dmesg | grep -i vfio  #查看绑定日志
nvidia-smi   #win和linux下查看显卡
cat /proc/cmdline   #查看是否intel_iommu=on
find /sys/kernel/iommu_groups/ -type l   #验证IOMMU隔离
```